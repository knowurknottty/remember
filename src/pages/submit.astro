---
import Base from "../layouts/Base.astro";

const category = Astro.url.searchParams.get("category") ?? "Mind Sight";
---
<Base title="Submit â€” Remember">
  <section class="card">
    <div class="k">Session logging</div>
    <h1>Submit a session</h1>
    <p>
      Sessions are saved in your browser's localStorage. No backend needed.
    </p>
    <form id="f" style="display:grid;gap:10px;margin-top:12px">
      <div>
        <label for="category">Category</label>
        <select id="category" name="category">
          {["Mind Sight","Remote Viewing","Precognition","Psychokinesis","Dowsing"].map(c => (
            <option value={c} selected={c === category}>{c}</option>
          ))}
        </select>
      </div>
      <div>
        <label for="setup">Setup (target, environment)</label>
        <input id="setup" name="setup" required placeholder="Example: 24 ring sort, blindfolded" />
      </div>
      <div class="grid2">
        <div>
          <label for="duration_seconds">Duration (seconds)</label>
          <input id="duration_seconds" name="duration_seconds" type="number" min="0" placeholder="e.g. 180" />
        </div>
        <div>
          <label for="score">Score (number)</label>
          <input id="score" name="score" type="number" step="0.01" placeholder="e.g. 18" />
        </div>
      </div>
      <div>
        <label for="vars">Variables (JSON)</label>
        <input id="vars" name="vars" class="mono" placeholder='{"sleep_hours":7.5,"caffeine_mg":200}' />
      </div>
      <div>
        <label for="notes">Notes</label>
        <textarea id="notes" name="notes" placeholder="Observations, sensations, anomalies..."></textarea>
      </div>
      <div class="row">
        <button class="btn primary" type="submit">Submit log</button>
        <a class="btn" href="/dashboard">Go to dashboard</a>
      </div>
      <p id="msg" class="mono" style="margin-top:8px;color:rgba(234,240,255,.85)"></p>
    </form>
  </section>
  <script>
    const form = document.getElementById("f");
    const msg = document.getElementById("msg");
    
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      msg.textContent = "Saving...";
      
      const payload = Object.fromEntries(new FormData(form).entries());
      payload.duration_seconds = payload.duration_seconds ? Number(payload.duration_seconds) : null;
      payload.score = payload.score ? Number(payload.score) : null;
      
      try {
        payload.vars = payload.vars ? JSON.parse(payload.vars) : null;
      } catch {
        msg.textContent = "Vars must be valid JSON.";
        return;
      }
      
      // Add timestamp and ID
      const session = {
        id: crypto.randomUUID(),
        created_at: new Date().toISOString(),
        ...payload
      };
      
      // Get existing sessions
      const sessions = JSON.parse(localStorage.getItem("remember_sessions") || "[]");
      sessions.push(session);
      localStorage.setItem("remember_sessions", JSON.stringify(sessions));
      
      form.reset();
      msg.textContent = "Saved! View on Dashboard.";
    });
  </script>
</Base>